    name: DevSecOps Analysis Pipeline (Audit Mode)

    on:
      push:
        branches: [ "main" ]
      workflow_dispatch:

    jobs:
      security-analysis:
        name: Static Security Analysis
        runs-on: ubuntu-latest
        permissions:
          actions: read
          contents: read
          security-events: write

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: 'SECURITY: Scan for secrets with Gitleaks'
            uses: gitleaks/gitleaks-action@v2
            with:
              report_format: sarif
              report_path: gitleaks-report.sarif
            continue-on-error: true # <-- TRÈS IMPORTANT

          - name: 'SECURITY: Scan source code with Semgrep'
            uses: semgrep/semgrep-action@v1
            with:
              format: sarif
              output: semgrep-report.sarif
            continue-on-error: true # <-- TRÈS IMPORTANT

          - name: 'SECURITY: Scan dependencies with Trivy (SCA)'
            uses: aquasecurity/trivy-action@master
            with:
              scan-type: 'fs'
              scan-ref: '.'
              format: 'sarif'
              output: 'trivy-report.sarif'
              exit-code: '0' # <-- TRÈS IMPORTANT

          - name: 'SECURITY: Scan IaC with Checkov'
            uses: bridgecrewio/checkov-action@master
            with:
              directory: '.'
              soft_fail: true # <-- TRÈS IMPORTANT
              output_format: sarif
              output_file_path: "checkov-report.sarif"

          - name: Upload Security Reports to GitHub
            uses: github/codeql-action/upload-sarif@v3
            with:
              sarif_file: .