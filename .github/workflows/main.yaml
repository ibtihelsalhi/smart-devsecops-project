    name: DevSecOps Analysis Pipeline

    on:
      push:
        branches: [ "main" ]
      workflow_dispatch:

    jobs:
      security-analysis:
        name: Static Security Analysis
        runs-on: ubuntu-latest
        permissions:
          actions: read
          contents: read
          security-events: write

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: 'SECURITY: Scan for secrets with Gitleaks'
            uses: gitleaks/gitleaks-action@v2
            with:
              report_format: sarif
              report_path: gitleaks-report.sarif
            continue-on-error: true

          - name: 'SECURITY: Scan source code with Semgrep'
            uses: semgrep/semgrep-action@v1
            with:
              config: "auto"
              format: "sarif"
              output: "semgrep-report.sarif"
            continue-on-error: true

          - name: 'SECURITY: Scan dependencies with Trivy (SCA)'
            uses: aquasecurity/trivy-action@master
            with:
              scan-type: 'fs'
              scan-ref: '.'
              format: 'sarif'
              output: 'trivy-sca-report.sarif'
              exit-code: '0'

          - name: 'SECURITY: Scan IaC with Checkov'
            uses: bridgecrewio/checkov-action@master
            with:
              directory: '.'
              soft_fail: true
              output_format: sarif
              output_file_path: "checkov-report.sarif"

          - name: Upload Security Reports
            uses: actions/upload-artifact@v4
            with:
              name: security-scan-reports
              path: |
                gitleaks-report.sarif
                semgrep-report.sarif
                trivy-sca-report.sarif
                checkov-report.sarif